<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Comments</title>
    <link rel="stylesheet" href="/styles.css">
</head>

<body>
    <div id="comments-container"></div>

    <script>
        // Connect to WebSocket
        const ws = new WebSocket(`ws://${window.location.host}`);
        const container = document.getElementById('comments-container');
        const MAX_COMMENTS = 250; // Maximum comments to keep

        ws.onopen = () => {
            console.log('✅ Connected to server');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === 'new_comment') {
                addComment(data.comment);
            }
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };

        ws.onclose = () => {
            console.log('❌ Disconnected from server');
            // Try to reconnect after 3 seconds
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        };

        function addComment(comment) {
            // Create comment element
            const commentEl = document.createElement('div');
            commentEl.className = 'comment';
            commentEl.innerHTML = `
                <div class="comment-avatar">
                    <img src="${comment.avatar || '/default-avatar.png'}" alt="${escapeHtml(comment.name)}">
                </div>
                <div class="comment-content">
                    <div class="comment-name">${escapeHtml(comment.name)}</div>
                    <div class="comment-message">${escapeHtml(comment.message)}</div>
                </div>
            `;

            // Insert at the TOP (prepend)
            container.insertBefore(commentEl, container.firstChild);

            // Trigger animation
            setTimeout(() => {
                commentEl.classList.add('show');
            }, 10);

            // Remove oldest comments if exceeds max (250)
            const comments = container.querySelectorAll('.comment');
            if (comments.length > MAX_COMMENTS) {
                // Remove from the END (oldest)
                for (let i = MAX_COMMENTS; i < comments.length; i++) {
                    comments[i].remove();
                }
            }

            // Scroll to top to show new comment
            container.scrollTop = 0;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>